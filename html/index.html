<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Music Wave Visualization with Harmony Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #canvas {
            flex: 1;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
            position: relative;
        }

        .harmony-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            min-width: 250px;
        }

        .harmony-overlay.active {
            display: block;
        }

        .harmony-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ffd700;
            text-align: center;
        }

        .chord-display {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .chord-name {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .chord-type {
            font-size: 14px;
            color: #aaa;
        }

        .note-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .note {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }

        .frequency-chart {
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }

        .controls {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #333;
            cursor: not-allowed;
            box-shadow: none;
        }

        .freeze-btn {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .freeze-btn:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .freeze-btn.active {
            background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(250, 112, 154, 0.8); }
            100% { box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4); }
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 30px;
        }

        input[type="range"] {
            width: 150px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 3px;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.5);
        }

        .info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            display: none;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(244, 67, 54, 0.9);
            padding: 15px 30px;
            border-radius: 30px;
            display: none;
            animation: slideDown 0.3s ease;
            max-width: 90%;
            white-space: pre-line;
            text-align: center;
            z-index: 1000;
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .visualization-modes {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 30px;
        }

        .mode-btn {
            background: transparent;
            padding: 8px 16px;
            font-size: 14px;
            box-shadow: none;
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        }

        @media (max-width: 768px) {
            .controls {
                justify-content: center;
            }
            
            .slider-container {
                width: 100%;
                justify-content: space-between;
            }
            
            input[type="range"] {
                flex: 1;
            }

            .harmony-overlay {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }

        /* „ÉÅ„É•„Éº„Éä„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .tuner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            min-width: 300px;
            text-align: center;
        }

        .tuner-overlay.active {
            display: block;
        }

        .tuner-note {
            font-size: 72px;
            font-weight: bold;
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .tuner-frequency {
            font-size: 24px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .tuner-cents {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 20px;
        }

        .tuner-meter {
            width: 100%;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .tuner-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: #fff;
            transform: translateX(-50%);
            transition: left 0.1s ease;
        }

        .tuner-meter-center {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: rgba(76, 175, 80, 0.5);
            transform: translateX(-50%);
        }

        .tuner-close {
            background: #f44336;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }

        .mic-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #f44336;
            border-radius: 50%;
            margin-left: 10px;
            animation: none;
        }

        .mic-indicator.active {
            background: #4caf50;
            animation: pulse-mic 1.5s infinite;
        }

        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
    </style>
</head>
<body>
    <div style="position: relative;">
        <canvas id="canvas"></canvas>
        <div class="harmony-overlay" id="harmonyOverlay">
            <div class="harmony-title">Ê§úÂá∫„Åï„Çå„ÅüÂíåÈü≥</div>
            <div class="chord-display" id="chordDisplay">
                <div class="chord-name" id="chordName">-</div>
                <div class="chord-type" id="chordType">-</div>
            </div>
            <div class="note-display" id="noteDisplay"></div>
            <div class="frequency-chart">
                <canvas id="frequencyCanvas"></canvas>
            </div>
        </div>
        <div class="tuner-overlay" id="tunerOverlay">
            <div class="tuner-note" id="tunerNote">-</div>
            <div class="tuner-frequency" id="tunerFrequency">- Hz</div>
            <div class="tuner-cents" id="tunerCents">- cents</div>
            <div class="tuner-meter">
                <div class="tuner-meter-center"></div>
                <div class="tuner-indicator" id="tunerIndicator"></div>
            </div>
            <div class="tuner-close" onclick="closeTuner()">Èñâ„Åò„Çã</div>
        </div>
    </div>
    
    <div class="controls">
        <label for="fileInput" class="file-label">
            Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
        </label>
        <input type="file" id="fileInput" accept="audio/*">
        
        <button id="playBtn" disabled>ÂÜçÁîü</button>
        <button id="pauseBtn" disabled>‰∏ÄÊôÇÂÅúÊ≠¢</button>
        <button id="freezeBtn" class="freeze-btn" disabled>Èü≥Â£∞Âõ∫ÂÆö</button>
        
        <div class="slider-container">
            <span>ÊÑüÂ∫¶:</span>
            <input type="range" id="sensitivity" min="0.5" max="3" step="0.1" value="1">
            <span id="sensitivityValue">1.0</span>
        </div>
        
        <div class="visualization-modes">
            <button class="mode-btn active" data-mode="bars">„Éê„Éº</button>
            <button class="mode-btn" data-mode="circle">„Çµ„Éº„ÇØ„É´</button>
            <button class="mode-btn" data-mode="wave">„Ç¶„Çß„Éº„Éñ</button>
        </div>
        
        <button id="micBtn" class="button" style="background: linear-gradient(45deg, #00d4ff, #0099cc);">
            üé§ „Éû„Ç§„ÇØÂÖ•Âäõ
        </button>
        
        <button id="tunerBtn" class="button" style="background: linear-gradient(45deg, #4caf50, #8bc34a);">
            üé∏ „ÉÅ„É•„Éº„Éä„Éº
        </button>
        
        <div class="info" id="info">
            „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            <span class="mic-indicator" id="micIndicator"></span>
        </div>
    </div>
    
    <div id="loading">
        <div class="spinner"></div>
        <div>Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    
    <div class="error" id="error"></div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆÂÆöÁæ©
        let audioContext;
        let analyser;
        let source;
        let dataArray;
        let bufferLength;
        let animationId;
        let audioBuffer;
        let startTime = 0;
        let pauseTime = 0;
        let isPlaying = false;
        let sensitivity = 1;
        let visualizationMode = 'bars';
        let isFrozen = false;
        let frozenData = null;
        let loopSource = null;
        let loopBuffer = null;
        let micStream = null;
        let micSource = null;
        let isMicActive = false;
        let tunerMode = false;
        let tunerAnimationId = null;
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const freezeBtn = document.getElementById('freezeBtn');
        const sensitivitySlider = document.getElementById('sensitivity');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const info = document.getElementById('info');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const harmonyOverlay = document.getElementById('harmonyOverlay');
        const noteDisplay = document.getElementById('noteDisplay');
        const chordDisplay = document.getElementById('chordDisplay');
        const chordName = document.getElementById('chordName');
        const chordType = document.getElementById('chordType');
        const frequencyCanvas = document.getElementById('frequencyCanvas');
        const freqCtx = frequencyCanvas.getContext('2d');
        const micBtn = document.getElementById('micBtn');
        const tunerBtn = document.getElementById('tunerBtn');
        const micIndicator = document.getElementById('micIndicator');
        const tunerOverlay = document.getElementById('tunerOverlay');
        const tunerNote = document.getElementById('tunerNote');
        const tunerFrequency = document.getElementById('tunerFrequency');
        const tunerCents = document.getElementById('tunerCents');
        const tunerIndicator = document.getElementById('tunerIndicator');
        
        // „Ç≥„Éº„ÉâÈÄ≤Ë°å„ÅÆÂÆöÁæ©
        const chordPatterns = {
            // „É°„Ç∏„É£„Éº„Ç≥„Éº„Éâ
            major: { intervals: [0, 4, 7], symbol: '', name: '„É°„Ç∏„É£„Éº' },
            // „Éû„Ç§„Éä„Éº„Ç≥„Éº„Éâ
            minor: { intervals: [0, 3, 7], symbol: 'm', name: '„Éû„Ç§„Éä„Éº' },
            // „Çª„Éñ„É≥„Çπ„Ç≥„Éº„Éâ
            dominant7: { intervals: [0, 4, 7, 10], symbol: '7', name: '„Çª„Éñ„É≥„Çπ' },
            major7: { intervals: [0, 4, 7, 11], symbol: 'M7', name: '„É°„Ç∏„É£„Éº„Çª„Éñ„É≥„Çπ' },
            minor7: { intervals: [0, 3, 7, 10], symbol: 'm7', name: '„Éû„Ç§„Éä„Éº„Çª„Éñ„É≥„Çπ' },
            // „Çµ„Çπ„Éö„É≥„Éá„ÉÉ„Éâ„Ç≥„Éº„Éâ
            sus2: { intervals: [0, 2, 7], symbol: 'sus2', name: '„Çµ„Çπ„Éö„É≥„Éá„ÉÉ„Éâ2' },
            sus4: { intervals: [0, 5, 7], symbol: 'sus4', name: '„Çµ„Çπ„Éö„É≥„Éá„ÉÉ„Éâ4' },
            // 6th„Ç≥„Éº„Éâ
            major6: { intervals: [0, 4, 7, 9], symbol: '6', name: '„Ç∑„ÉÉ„ÇØ„Çπ' },
            minor6: { intervals: [0, 3, 7, 9], symbol: 'm6', name: '„Éû„Ç§„Éä„Éº„Ç∑„ÉÉ„ÇØ„Çπ' },
            // „Éá„Ç£„Éü„Éã„ÉÉ„Ç∑„É•„Éª„Ç™„Éº„ÇÆ„É•„É°„É≥„Éà
            dim: { intervals: [0, 3, 6], symbol: 'dim', name: '„Éá„Ç£„Éü„Éã„ÉÉ„Ç∑„É•' },
            dim7: { intervals: [0, 3, 6, 9], symbol: 'dim7', name: '„Éá„Ç£„Éü„Éã„ÉÉ„Ç∑„É•„Çª„Éñ„É≥„Çπ' },
            aug: { intervals: [0, 4, 8], symbol: 'aug', name: '„Ç™„Éº„ÇÆ„É•„É°„É≥„Éà' },
            // 9th„Ç≥„Éº„Éâ
            add9: { intervals: [0, 4, 7, 14], symbol: 'add9', name: '„Ç¢„Éâ„Éä„Ç§„É≥„Çπ' },
            major9: { intervals: [0, 4, 7, 11, 14], symbol: 'M9', name: '„É°„Ç∏„É£„Éº„Éä„Ç§„É≥„Çπ' },
            minor9: { intervals: [0, 3, 7, 10, 14], symbol: 'm9', name: '„Éû„Ç§„Éä„Éº„Éä„Ç§„É≥„Çπ' },
            // „Åù„ÅÆ‰ªñ
            minorMajor7: { intervals: [0, 3, 7, 11], symbol: 'mM7', name: '„Éû„Ç§„Éä„Éº„É°„Ç∏„É£„Éº„Çª„Éñ„É≥„Çπ' },
            halfDim7: { intervals: [0, 3, 6, 10], symbol: 'm7‚ô≠5', name: '„Éè„Éº„Éï„Éá„Ç£„Éü„Éã„ÉÉ„Ç∑„É•' }
        };
        
        // Èü≥Èöé„Å®Âë®Ê≥¢Êï∞„ÅÆÂØæÂøúË°®
        const noteFrequencies = {
            'C': [16.35, 32.70, 65.41, 130.81, 261.63, 523.25, 1046.50, 2093.00, 4186.01],
            'C#': [17.32, 34.65, 69.30, 138.59, 277.18, 554.37, 1108.73, 2217.46, 4434.92],
            'D': [18.35, 36.71, 73.42, 146.83, 293.66, 587.33, 1174.66, 2349.32, 4698.63],
            'D#': [19.45, 38.89, 77.78, 155.56, 311.13, 622.25, 1244.51, 2489.02, 4978.03],
            'E': [20.60, 41.20, 82.41, 164.81, 329.63, 659.25, 1318.51, 2637.02, 5274.04],
            'F': [21.83, 43.65, 87.31, 174.61, 349.23, 698.46, 1396.91, 2793.83, 5587.65],
            'F#': [23.12, 46.25, 92.50, 185.00, 369.99, 739.99, 1479.98, 2959.96, 5919.91],
            'G': [24.50, 49.00, 98.00, 196.00, 392.00, 783.99, 1567.98, 3135.96, 6271.93],
            'G#': [25.96, 51.91, 103.83, 207.65, 415.30, 830.61, 1661.22, 3322.44, 6644.88],
            'A': [27.50, 55.00, 110.00, 220.00, 440.00, 880.00, 1760.00, 3520.00, 7040.00],
            'A#': [29.14, 58.27, 116.54, 233.08, 466.16, 932.33, 1864.66, 3729.31, 7458.62],
            'B': [30.87, 61.74, 123.47, 246.94, 493.88, 987.77, 1975.53, 3951.07, 7902.13]
        };
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÅÆ„É™„Çµ„Ç§„Ç∫
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - document.querySelector('.controls').offsetHeight;
            
            // Âë®Ê≥¢Êï∞„Ç≠„É£„É≥„Éê„Çπ„ÅÆ„Çµ„Ç§„Ç∫Ë®≠ÂÆö
            frequencyCanvas.width = frequencyCanvas.parentElement.offsetWidth - 20;
            frequencyCanvas.height = 130;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // AudioContext„ÅÆÂàùÊúüÂåñ
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096; // „Çà„ÇäÈ´ò„ÅÑËß£ÂÉèÂ∫¶„ÅßÂë®Ê≥¢Êï∞ÂàÜÊûê
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
        }
        
        // Âë®Ê≥¢Êï∞„Åã„ÇâÈü≥Èöé„ÇíÊ§úÂá∫
        function frequencyToNote(frequency) {
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            if (frequency === 0) return null;
            
            const halfSteps = 12 * Math.log2(frequency / C0);
            const octave = Math.floor(halfSteps / 12);
            const noteIndex = Math.round(halfSteps % 12);
            
            return {
                note: noteNames[noteIndex],
                octave: octave,
                frequency: frequency,
                cents: (halfSteps % 12 - noteIndex) * 100
            };
        }
        
        // Âë®Ê≥¢Êï∞„Çπ„Éö„ÇØ„Éà„É´„Åã„Çâ‰∏ªË¶Å„Å™Âë®Ê≥¢Êï∞„ÇíÊ§úÂá∫
        function detectPeakFrequencies(dataArray, sampleRate) {
            const frequencies = [];
            const minFreq = 80; // ÊúÄÂ∞èÂë®Ê≥¢Êï∞ (Hz)
            const maxFreq = 2000; // ÊúÄÂ§ßÂë®Ê≥¢Êï∞ (Hz)
            const threshold = 50; // ÈñæÂÄ§
            
            for (let i = 0; i < dataArray.length; i++) {
                const frequency = i * sampleRate / (dataArray.length * 2);
                
                if (frequency >= minFreq && frequency <= maxFreq && dataArray[i] > threshold) {
                    // „Éî„Éº„ÇØÊ§úÂá∫
                    if (i > 0 && i < dataArray.length - 1 &&
                        dataArray[i] > dataArray[i - 1] &&
                        dataArray[i] > dataArray[i + 1]) {
                        frequencies.push({
                            frequency: frequency,
                            amplitude: dataArray[i]
                        });
                    }
                }
            }
            
            // ÊåØÂπÖ„Åß„ÇΩ„Éº„Éà„Åó„Å¶‰∏ä‰Ωç„ÇíËøî„Åô
            return frequencies
                .sort((a, b) => b.amplitude - a.amplitude)
                .slice(0, 8)
                .map(f => f.frequency);
        }
        
        // Èü≥ÈöéÂêç„ÇíÂçäÈü≥Èöé„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å´Â§âÊèõ
        function noteToSemitone(noteName) {
            if (!noteName) return null;
            const noteMap = {
                'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
                'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
            };
            return noteMap[noteName];
        }
        
        // „Ç≥„Éº„Éâ„ÇíÂà§ÂÆö
        function identifyChord(notes) {
            if (!notes || notes.length < 2) return null;
            
            // Èü≥ÈöéÂêç„ÇíÊäΩÂá∫„Åó„Å¶„ÇΩ„Éº„Éà
            const noteNames = notes.map(n => n.note).filter(n => n !== null);
            const semitones = noteNames.map(noteToSemitone).filter(s => s !== null).sort((a, b) => a - b);
            
            if (semitones.length < 2) return null;
            
            // Èü≥ÈöéÂêç„ÅÆ„Éû„ÉÉ„Éó„Çí‰ΩúÊàê
            const semitoneToNote = {
                0: 'C', 1: 'C#', 2: 'D', 3: 'D#', 4: 'E', 5: 'F',
                6: 'F#', 7: 'G', 8: 'G#', 9: 'A', 10: 'A#', 11: 'B'
            };
            
            // ÂêÑÈü≥„Çí„É´„Éº„Éà„Å®„Åó„Å¶Ë©¶„Åô
            for (let rootIndex = 0; rootIndex < semitones.length; rootIndex++) {
                const root = semitones[rootIndex];
                const intervals = semitones.map(note => {
                    const interval = (note - root + 12) % 12;
                    return interval;
                }).filter((v, i, a) => a.indexOf(v) === i).sort((a, b) => a - b);
                
                // „Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                for (const [chordType, pattern] of Object.entries(chordPatterns)) {
                    if (intervals.length === pattern.intervals.length) {
                        let match = true;
                        for (let i = 0; i < intervals.length; i++) {
                            if (intervals[i] !== pattern.intervals[i]) {
                                match = false;
                                break;
                            }
                        }
                        if (match) {
                            const rootNote = semitoneToNote[root];
                            return {
                                root: rootNote,
                                type: chordType,
                                symbol: pattern.symbol,
                                name: pattern.name,
                                notes: noteNames
                            };
                        }
                    }
                }
            }
            
            // ÈÉ®ÂàÜ‰∏ÄËá¥„ÇíË©¶„ÅôÔºà3ÂíåÈü≥‰ª•‰∏ä„ÅÆÂ†¥ÂêàÔºâ
            if (semitones.length >= 3) {
                for (let rootIndex = 0; rootIndex < semitones.length; rootIndex++) {
                    const root = semitones[rootIndex];
                    const intervals = semitones.map(note => (note - root + 12) % 12)
                        .filter((v, i, a) => a.indexOf(v) === i).sort((a, b) => a - b);
                    
                    // Âü∫Êú¨ÁöÑ„Å™„Ç≥„Éº„Éâ„Éë„Çø„Éº„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    for (const [chordType, pattern] of Object.entries(chordPatterns)) {
                        if (pattern.intervals.length <= intervals.length) {
                            let matchCount = 0;
                            for (const patternInterval of pattern.intervals) {
                                if (intervals.includes(patternInterval)) {
                                    matchCount++;
                                }
                            }
                            if (matchCount >= pattern.intervals.length * 0.75) {
                                const rootNote = semitoneToNote[root];
                                return {
                                    root: rootNote,
                                    type: chordType,
                                    symbol: pattern.symbol,
                                    name: pattern.name,
                                    notes: noteNames,
                                    partial: true
                                };
                            }
                        }
                    }
                }
            }
            
            return null;
        }
        
        // ÂíåÈü≥„ÅÆÊ§úÂá∫„Å®Ë°®Á§∫
        function analyzeHarmony() {
            if (!analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            const sampleRate = audioContext.sampleRate;
            const peakFrequencies = detectPeakFrequencies(dataArray, sampleRate);
            
            const notes = peakFrequencies
                .map(freq => frequencyToNote(freq))
                .filter(note => note !== null);
            
            // ÈáçË§á„ÇíÈô§Âéª
            const uniqueNotes = notes.reduce((acc, note) => {
                const key = note.note;
                if (!acc.find(n => n.note === key)) {
                    acc.push(note);
                }
                return acc;
            }, []);
            
            // Èü≥Èöé„ÇíË°®Á§∫
            noteDisplay.innerHTML = uniqueNotes
                .map(note => `<div class="note">${note.note}${note.octave}</div>`)
                .join('');
            
            // „Ç≥„Éº„Éâ„ÇíÂà§ÂÆö
            const chord = identifyChord(uniqueNotes);
            if (chord && chord.root) {
                // ‚ô≠„Å®‚ôØ„ÅÆË°®Á§∫„ÇíË™øÊï¥
                let displayRoot = chord.root.replace('#', '‚ôØ').replace('b', '‚ô≠');
                chordName.textContent = displayRoot + chord.symbol;
                chordType.textContent = chord.name + (chord.partial ? ' (Êé®ÂÆö)' : '');
            } else {
                chordName.textContent = '-';
                chordType.textContent = 'Âà§ÂÆö„Åß„Åç„Åæ„Åõ„Çì';
            }
            
            // Âë®Ê≥¢Êï∞„Çπ„Éö„ÇØ„Éà„É©„É†„ÇíÊèèÁîª
            drawFrequencySpectrum();
            
            return { notes: uniqueNotes, chord: chord, rawData: dataArray.slice() };
        }
        
        // Âë®Ê≥¢Êï∞„Çπ„Éö„ÇØ„Éà„É©„É†„ÅÆÊèèÁîª
        function drawFrequencySpectrum() {
            freqCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            freqCtx.fillRect(0, 0, frequencyCanvas.width, frequencyCanvas.height);
            
            const barWidth = frequencyCanvas.width / bufferLength * 10;
            let x = 0;
            
            for (let i = 0; i < bufferLength / 10; i++) {
                const barHeight = (dataArray[i] / 255) * frequencyCanvas.height * 0.8;
                
                const gradient = freqCtx.createLinearGradient(0, frequencyCanvas.height - barHeight, 0, frequencyCanvas.height);
                gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
                gradient.addColorStop(1, 'rgba(118, 75, 162, 0.3)');
                
                freqCtx.fillStyle = gradient;
                freqCtx.fillRect(x, frequencyCanvas.height - barHeight, barWidth - 1, barHeight);
                
                x += barWidth;
            }
        }
        
        // „É´„Éº„ÉóÁî®„ÅÆ„Éê„ÉÉ„Éï„Ç°„Çí‰ΩúÊàê
        function createLoopBuffer(duration = 0.1) {
            if (!audioBuffer || !audioContext) return null;
            
            const sampleRate = audioContext.sampleRate;
            const loopDuration = Math.min(duration, audioBuffer.duration - pauseTime);
            const startSample = Math.floor(pauseTime * sampleRate);
            const endSample = Math.floor((pauseTime + loopDuration) * sampleRate);
            const length = endSample - startSample;
            
            const newBuffer = audioContext.createBuffer(
                audioBuffer.numberOfChannels,
                length,
                sampleRate
            );
            
            for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                const sourceData = audioBuffer.getChannelData(channel);
                const targetData = newBuffer.getChannelData(channel);
                
                for (let i = 0; i < length; i++) {
                    targetData[i] = sourceData[startSample + i];
                }
            }
            
            return newBuffer;
        }
        
        // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Ç§„Éô„É≥„Éà
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                loading.style.display = 'block';
                errorDiv.style.display = 'none';
                info.textContent = `Ë™≠„ÅøËæº„Åø‰∏≠: ${file.name}`;
                
                initAudioContext();
                
                const arrayBuffer = await file.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                loading.style.display = 'none';
                info.textContent = `Ê∫ñÂÇôÂÆå‰∫Ü: ${file.name}`;
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                freezeBtn.disabled = true;
                
                // „É™„Çª„ÉÉ„Éà
                if (source) {
                    source.stop();
                    source.disconnect();
                }
                if (loopSource) {
                    loopSource.stop();
                    loopSource.disconnect();
                }
                isPlaying = false;
                isFrozen = false;
                pauseTime = 0;
                harmonyOverlay.classList.remove('active');
                freezeBtn.classList.remove('active');
                
            } catch (error) {
                loading.style.display = 'none';
                showError('Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                console.error('Audio loading error:', error);
            }
        });
        
        // ÂÜçÁîü„Éú„Çø„É≥
        playBtn.addEventListener('click', () => {
            if (!audioBuffer) return;
            
            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // „Éï„É™„Éº„Ç∫Áä∂ÊÖã„ÇíËß£Èô§
                if (isFrozen) {
                    isFrozen = false;
                    freezeBtn.classList.remove('active');
                    harmonyOverlay.classList.remove('active');
                    if (loopSource) {
                        loopSource.stop();
                        loopSource.disconnect();
                    }
                }
                
                source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                const offset = pauseTime;
                source.start(0, offset);
                startTime = audioContext.currentTime - offset;
                
                isPlaying = true;
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                freezeBtn.disabled = false;
                
                source.onended = () => {
                    if (isPlaying) {
                        isPlaying = false;
                        playBtn.disabled = false;
                        pauseBtn.disabled = true;
                        freezeBtn.disabled = true;
                        pauseTime = 0;
                        cancelAnimationFrame(animationId);
                    }
                };
                
                visualize();
                
            } catch (error) {
                showError('ÂÜçÁîü„Ç®„É©„Éº: ' + error.message);
                console.error('Playback error:', error);
            }
        });
        
        // ‰∏ÄÊôÇÂÅúÊ≠¢„Éú„Çø„É≥
        pauseBtn.addEventListener('click', () => {
            if (!isPlaying || !source) return;
            
            pauseTime = audioContext.currentTime - startTime;
            source.stop();
            source.disconnect();
            
            isPlaying = false;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            
            // ‰∏ÄÊôÇÂÅúÊ≠¢ÊôÇ„Å´ÂíåÈü≥„ÇíÂàÜÊûê
            const harmonyData = analyzeHarmony();
            harmonyOverlay.classList.add('active');
            frozenData = harmonyData;
            
            cancelAnimationFrame(animationId);
        });
        
        // Èü≥Â£∞Âõ∫ÂÆö„Éú„Çø„É≥
        freezeBtn.addEventListener('click', () => {
            if (!frozenData || isPlaying) return;
            
            isFrozen = !isFrozen;
            freezeBtn.classList.toggle('active');
            
            if (isFrozen) {
                // „É´„Éº„ÉóÂÜçÁîüÈñãÂßã
                loopBuffer = createLoopBuffer(0.2); // 0.2Áßí„ÅÆ„É´„Éº„Éó
                if (loopBuffer) {
                    playLoop();
                }
            } else {
                // „É´„Éº„ÉóÂÜçÁîüÂÅúÊ≠¢
                if (loopSource) {
                    loopSource.stop();
                    loopSource.disconnect();
                }
            }
        });
        
        // „É´„Éº„ÉóÂÜçÁîü
        function playLoop() {
            if (!loopBuffer || !isFrozen) return;
            
            loopSource = audioContext.createBufferSource();
            loopSource.buffer = loopBuffer;
            loopSource.loop = true;
            loopSource.connect(audioContext.destination);
            loopSource.start();
        }
        
        // ÊÑüÂ∫¶„Çπ„É©„Ç§„ÉÄ„Éº
        sensitivitySlider.addEventListener('input', (e) => {
            sensitivity = parseFloat(e.target.value);
            sensitivityValue.textContent = sensitivity.toFixed(1);
        });
        
        // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Çº„Éº„Ç∑„Éß„É≥„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                visualizationMode = e.target.dataset.mode;
            });
        });
        
        // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Çº„Éº„Ç∑„Éß„É≥
        function visualize() {
            animationId = requestAnimationFrame(visualize);
            
            if (!isFrozen) {
                analyser.getByteFrequencyData(dataArray);
            } else if (frozenData && frozenData.rawData) {
                // „Éï„É™„Éº„Ç∫ÊôÇ„ÅØ‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„Çí‰ΩøÁî®
                dataArray = new Uint8Array(frozenData.rawData);
            }
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            switch (visualizationMode) {
                case 'bars':
                    drawBars();
                    break;
                case 'circle':
                    drawCircle();
                    break;
                case 'wave':
                    drawWave();
                    break;
            }
            
            // „Éï„É™„Éº„Ç∫ÊôÇ„ÇÇÂíåÈü≥ÂàÜÊûê„ÇíÊõ¥Êñ∞
            if (isFrozen && frozenData) {
                analyzeHarmony();
            }
        }
        
        // „Éê„ÉºË°®Á§∫
        function drawBars() {
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height * 0.8 * sensitivity;
                
                const r = (dataArray[i] / 255) * 255;
                const g = 100 + (i / bufferLength) * 155;
                const b = 200;
                
                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        }
        
        // „Çµ„Éº„ÇØ„É´Ë°®Á§∫
        function drawCircle() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.3;
            
            ctx.beginPath();
            
            for (let i = 0; i < bufferLength; i++) {
                const amplitude = (dataArray[i] / 255) * sensitivity;
                const angle = (i / bufferLength) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * (radius + amplitude * 100);
                const y = centerY + Math.sin(angle) * (radius + amplitude * 100);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.closePath();
            
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
            gradient.addColorStop(1, 'rgba(118, 75, 162, 0.3)');
            
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // „Ç¶„Çß„Éº„ÉñË°®Á§∫
        function drawWave() {
            const tempArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(tempArray);
            
            ctx.lineWidth = 3;
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.8)';
            ctx.beginPath();
            
            const sliceWidth = canvas.width / bufferLength;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                const v = tempArray[i] / 128.0;
                const y = (v * canvas.height / 2) * sensitivity;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
            
            // „Ç∞„É≠„ÉºÂäπÊûú
            ctx.shadowBlur = 20;
            ctx.shadowColor = 'rgba(102, 126, 234, 0.5)';
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // „Éû„Ç§„ÇØÂÖ•Âäõ„ÅÆÈñãÂßã/ÂÅúÊ≠¢
        micBtn.addEventListener('click', async () => {
            if (!isMicActive) {
                try {
                    // „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØ
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                        showError('„Éû„Ç§„ÇØÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅHTTPSÊé•Á∂ö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\n„É≠„Éº„Ç´„É´„Åß„ÉÜ„Çπ„Éà„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åó„Å¶localhostÁµåÁî±„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    initAudioContext();
                    
                    // „Éñ„É©„Ç¶„Ç∂„ÅÆÂØæÂøú„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showError('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Éû„Ç§„ÇØÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nChrome„ÄÅFirefox„ÄÅEdgeÁ≠â„ÅÆÊúÄÊñ∞„Éñ„É©„Ç¶„Ç∂„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    // „Éû„Ç§„ÇØ„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÇíË¶ÅÊ±Ç
                    micStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    // „Éû„Ç§„ÇØ„ÇΩ„Éº„Çπ„Çí‰ΩúÊàê
                    micSource = audioContext.createMediaStreamSource(micStream);
                    micSource.connect(analyser);
                    
                    isMicActive = true;
                    micBtn.textContent = 'üé§ „Éû„Ç§„ÇØÂÅúÊ≠¢';
                    micBtn.style.background = 'linear-gradient(45deg, #f44336, #e91e63)';
                    micIndicator.classList.add('active');
                    info.textContent = '„Éû„Ç§„ÇØÂÖ•Âäõ‰∏≠...';
                    
                    // Êó¢Â≠ò„ÅÆÈü≥Ê•Ω„ÇíÂÅúÊ≠¢
                    if (isPlaying && source) {
                        source.stop();
                        source.disconnect();
                        isPlaying = false;
                        playBtn.disabled = false;
                        pauseBtn.disabled = true;
                    }
                    
                    // „Éè„Éº„É¢„Éã„ÉºË°®Á§∫„ÇíÊúâÂäπÂåñ
                    harmonyOverlay.classList.add('active');
                    
                    // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Çº„Éº„Ç∑„Éß„É≥ÈñãÂßã
                    if (!animationId) {
                        visualize();
                    }
                    
                    // „É™„Ç¢„É´„Çø„Ç§„É†ÂíåÈü≥ÂàÜÊûêÈñãÂßã
                    startRealtimeHarmonyAnalysis();
                    
                } catch (error) {
                    console.error('Mic access error:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        showError('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\n„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else if (error.name === 'NotFoundError') {
                        showError('„Éû„Ç§„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\n„Éû„Ç§„ÇØ„ÅåÊ≠£„Åó„ÅèÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else if (error.name === 'SecurityError' || error.name === 'TypeError') {
                        showError('„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç®„É©„Éº: „Åì„ÅÆÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ‰ª•‰∏ã„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅåÂøÖË¶Å„Åß„ÅôÔºö\n' +
                                '1. HTTPS„Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã\n' +
                                '2. localhost „Åæ„Åü„ÅØ 127.0.0.1 „Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã\n' +
                                '3. „É≠„Éº„Ç´„É´„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åô„ÇãÔºà‰æã: python -m http.serverÔºâ');
                    } else {
                        showError('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº: ' + error.message);
                    }
                }
            } else {
                stopMicInput();
            }
        });

        // „Éû„Ç§„ÇØÂÖ•Âäõ„ÅÆÂÅúÊ≠¢
        function stopMicInput() {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }
            
            if (micSource) {
                micSource.disconnect();
                micSource = null;
            }
            
            isMicActive = false;
            micBtn.textContent = 'üé§ „Éû„Ç§„ÇØÂÖ•Âäõ';
            micBtn.style.background = 'linear-gradient(45deg, #00d4ff, #0099cc)';
            micIndicator.classList.remove('active');
            info.textContent = '„Éû„Ç§„ÇØÂÖ•Âäõ„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü';
            
            if (!isPlaying) {
                harmonyOverlay.classList.remove('active');
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†ÂíåÈü≥ÂàÜÊûê
        function startRealtimeHarmonyAnalysis() {
            if (!isMicActive) return;
            
            // ÂÆöÊúüÁöÑ„Å´ÂíåÈü≥„ÇíÂàÜÊûê
            const analyzeInterval = setInterval(() => {
                if (!isMicActive) {
                    clearInterval(analyzeInterval);
                    return;
                }
                
                analyzeHarmony();
            }, 100); // 100ms„Åî„Å®„Å´ÂàÜÊûê
        }

        // „ÉÅ„É•„Éº„Éä„Éº„É¢„Éº„Éâ
        tunerBtn.addEventListener('click', async () => {
            if (!tunerMode) {
                try {
                    // „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØ
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                        showError('„ÉÅ„É•„Éº„Éä„ÉºÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅHTTPSÊé•Á∂ö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\n„É≠„Éº„Ç´„É´„Åß„ÉÜ„Çπ„Éà„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åó„Å¶localhostÁµåÁî±„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    initAudioContext();
                    
                    // „Éñ„É©„Ç¶„Ç∂„ÅÆÂØæÂøú„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showError('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Éû„Ç§„ÇØÂÖ•Âäõ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nChrome„ÄÅFirefox„ÄÅEdgeÁ≠â„ÅÆÊúÄÊñ∞„Éñ„É©„Ç¶„Ç∂„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    if (!micStream) {
                        micStream = await navigator.mediaDevices.getUserMedia({ 
                            audio: {
                                echoCancellation: false,  // „ÉÅ„É•„Éº„Éä„Éº„Åß„ÅØÁÑ°ÂäπÂåñ
                                noiseSuppression: false,  // „Çà„ÇäÊ≠£Á¢∫„Å™Âë®Ê≥¢Êï∞Ê§úÂá∫„ÅÆ„Åü„ÇÅ
                                autoGainControl: false
                            }
                        });
                    }
                    
                    if (!micSource) {
                        micSource = audioContext.createMediaStreamSource(micStream);
                        micSource.connect(analyser);
                    }
                    
                    tunerMode = true;
                    tunerOverlay.classList.add('active');
                    startTuner();
                    
                } catch (error) {
                    console.error('Mic access error:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        showError('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\n„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else if (error.name === 'NotFoundError') {
                        showError('„Éû„Ç§„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\n„Éû„Ç§„ÇØ„ÅåÊ≠£„Åó„ÅèÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else if (error.name === 'SecurityError' || error.name === 'TypeError') {
                        showError('„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç®„É©„Éº: „Åì„ÅÆÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ‰ª•‰∏ã„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅåÂøÖË¶Å„Åß„ÅôÔºö\n' +
                                '1. HTTPS„Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã\n' +
                                '2. localhost „Åæ„Åü„ÅØ 127.0.0.1 „Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã\n' +
                                '3. „É≠„Éº„Ç´„É´„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åô„ÇãÔºà‰æã: python -m http.serverÔºâ');
                    } else {
                        showError('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº: ' + error.message);
                    }
                }
            } else {
                closeTuner();
            }
        });

        // „ÉÅ„É•„Éº„Éä„Éº„ÅÆÈñãÂßã
        function startTuner() {
            if (!tunerMode) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // „Éî„ÉÉ„ÉÅÊ§úÂá∫ÔºàËá™Â∑±Áõ∏Èñ¢Ê≥ïÔºâ
            const pitch = detectPitch();
            
            if (pitch > 0) {
                const noteInfo = frequencyToNote(pitch);
                if (noteInfo) {
                    tunerNote.textContent = noteInfo.note + noteInfo.octave;
                    tunerFrequency.textContent = pitch.toFixed(1) + ' Hz';
                    
                    // „Çª„É≥„ÉàÂÄ§„ÅÆË®àÁÆó„Å®Ë°®Á§∫
                    const cents = noteInfo.cents;
                    tunerCents.textContent = (cents > 0 ? '+' : '') + cents.toFixed(0) + ' cents';
                    
                    // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                    const position = 50 + (cents / 50) * 45; // ¬±50„Çª„É≥„Éà„ÇíÁîªÈù¢ÂπÖ„Å´„Éû„ÉÉ„Éó
                    tunerIndicator.style.left = Math.max(5, Math.min(95, position)) + '%';
                    
                    // Ëâ≤„ÅÆÂ§âÊõ¥Ôºà„ÉÅ„É•„Éº„Éã„É≥„Ç∞„ÅåÂêà„Å£„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„ÅãÔºâ
                    if (Math.abs(cents) < 5) {
                        tunerIndicator.style.background = '#4caf50';
                        tunerNote.style.background = 'linear-gradient(45deg, #4caf50, #8bc34a)';
                        tunerNote.style.webkitBackgroundClip = 'text';
                        tunerNote.style.webkitTextFillColor = 'transparent';
                    } else {
                        tunerIndicator.style.background = '#fff';
                        tunerNote.style.background = 'linear-gradient(45deg, #ff9800, #ff5722)';
                        tunerNote.style.webkitBackgroundClip = 'text';
                        tunerNote.style.webkitTextFillColor = 'transparent';
                    }
                }
            }
            
            tunerAnimationId = requestAnimationFrame(startTuner);
        }

        // „Éî„ÉÉ„ÉÅÊ§úÂá∫ÔºàËá™Â∑±Áõ∏Èñ¢Ê≥ïÔºâ
        function detectPitch() {
            const sampleRate = audioContext.sampleRate;
            const bufferSize = analyser.fftSize;
            const buffer = new Float32Array(bufferSize);
            analyser.getFloatTimeDomainData(buffer);
            
            // Ëá™Â∑±Áõ∏Èñ¢
            const r = new Array(bufferSize).fill(0);
            for (let i = 0; i < bufferSize; i++) {
                for (let j = 0; j < bufferSize - i; j++) {
                    r[i] += buffer[j] * buffer[j + i];
                }
            }
            
            // „Éî„Éº„ÇØÊ§úÂá∫
            let maxValue = 0;
            let bestOffset = -1;
            const minOffset = Math.floor(sampleRate / 800); // 800Hz
            const maxOffset = Math.floor(sampleRate / 80);  // 80Hz
            
            for (let offset = minOffset; offset < maxOffset; offset++) {
                if (r[offset] > maxValue) {
                    maxValue = r[offset];
                    bestOffset = offset;
                }
            }
            
            if (bestOffset === -1 || r[0] < 0.01) {
                return -1;
            }
            
            // Ë£úÈñì„Åß„Çà„ÇäÊ≠£Á¢∫„Å™Âë®Ê≥¢Êï∞„ÇíË®àÁÆó
            const y1 = r[bestOffset - 1] || 0;
            const y2 = r[bestOffset];
            const y3 = r[bestOffset + 1] || 0;
            const x = (y3 - y1) / (2 * (2 * y2 - y1 - y3));
            
            return sampleRate / (bestOffset + x);
        }

        // „ÉÅ„É•„Éº„Éä„Éº„ÇíÈñâ„Åò„Çã
        function closeTuner() {
            tunerMode = false;
            tunerOverlay.classList.remove('active');
            
            if (tunerAnimationId) {
                cancelAnimationFrame(tunerAnimationId);
                tunerAnimationId = null;
            }
            
            // „Éû„Ç§„ÇØÂÖ•Âäõ„ÇÇÂÅúÊ≠¢Ôºà„Éû„Ç§„ÇØ„É¢„Éº„Éâ„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
            if (!isMicActive) {
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                    micStream = null;
                }
                
                if (micSource) {
                    micSource.disconnect();
                    micSource = null;
                }
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©ÔºàonclickÁî®Ôºâ
        window.closeTuner = closeTuner;
    </script>
</body>
</html>